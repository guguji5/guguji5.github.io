var e=Object.defineProperty,t=Object.prototype.hasOwnProperty,a=Object.getOwnPropertySymbols,n=Object.prototype.propertyIsEnumerable,l=(t,a,n)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[a]=n,r=(e,r)=>{for(var s in r||(r={}))t.call(r,s)&&l(e,s,r[s]);if(a)for(var s of a(r))n.call(r,s)&&l(e,s,r[s]);return e};import{aN as s,r as c,R as i,w as m,aO as o,as as u,y as d,t as p,T as v,h as E,b as f,a8 as _,q as y,x as h,k as g,l as N}from"./vendor.6a8dc018.js";import{S,T as b,V as k,a4 as w,B as x,a6 as O,a7 as I,a0 as j,a5 as z}from"./index.366ccd84.js";import{a as C}from"./index.e28e6ead.js";const P=s({scriptUrl:"/font/iconfont.js"}),$=e=>{const{list:t}=e;return c.createElement("div",{className:"statistics_con"},c.createElement(i,{justify:"space-around"},null==t?void 0:t.map(((e,t)=>c.createElement(m,{key:t},c.createElement(o,{to:null==e?void 0:e.url},c.createElement(u,{align:"center"},c.createElement(P,{type:null==e?void 0:e.icon,className:"statistics_icon",style:{fontSize:"48px"}}),c.createElement("div",null,c.createElement("p",{className:"name"},null==e?void 0:e.name),c.createElement("p",null,c.createElement("span",{className:"num"},null==e?void 0:e.num),c.createElement("span",{className:"unit"},"个"))))))))))},J=[{name:"资源总量",id:"resource_total",num:0,icon:"icon-ziyuanzongliang",url:"/resource"},{name:"策略总量",id:"alert_rule_total",num:0,icon:"icon-celvezongliang",url:"/strategy"},{name:"大盘总量",id:"dashboard_total",num:0,icon:"icon-dapanzongliang",url:"/dashboard"},{name:"用户总量",id:"user_total",num:0,icon:"icon-yonghuzongliang",url:"/manage/user"},{name:"团队总量",id:"user_group_total",num:0,icon:"icon-tuanduizongliang",url:"/manage/group"}],{Option:q}=p,D=localStorage.getItem("indicatorKeysUser")||"[]",T=JSON.parse(D).length>0?JSON.parse(D):["system_cpu_util","system_mem_used_percent","system_disk_used_percent","system_io_util"],Y=()=>{const[e,t]=c.useState(!0),[a,n]=c.useState({}),[l,s]=c.useState({}),[o,u]=c.useState(T),[E,f]=c.useState([]),_=async t=>{const c=await function(e){const t=Math.floor((new Date).getTime()/1e3),a=r({start:t-3600,end:t},e);return S(`${b}/api/n9e/query`,{method:k.Post,data:a})}({params:[{prome_ql:`topk(20, avg(${t}) by (ident))`}]});if(c&&c.dat){const r=[...c.dat];r.forEach((e=>{e.metric=t})),a[t]=[...r];const m=JSON.parse(JSON.stringify(a));(i=m)&&Object.keys(i).length>0&&(Object.keys(i).forEach((e=>{const t=e,a=i[t].map(((e,t)=>Object.assign({},{ident:e.ident,metric:e.metric,value:e.values[e.values.length-1].v,key:t})));l[t]=[...a]})),e&&s(l)),e&&n(m)}var i},y=[{title:"资源标识",dataIndex:"ident"},{title:"值",dataIndex:"value",defaultSortOrder:"descend",sortDirections:["ascend","descend","ascend"],sorter:{compare:(e,t)=>e.value-t.value,multiple:3}}];async function h(t,a){const n=await function(e){return S(`${b}/api/n9e/tag-metrics`,{method:k.Post,data:e})}(r({limit:150},t));if(n&&n.dat){const t=n.dat.metrics||[];if(e){if(null==a)for(let a=0;a<o.length;a++)E[a]=t;else E[a]=t;const e=[...E];f(e)}}}function g(e,t){const a=t.key.split("-")[0]||0;o.splice(a,1,e);const n=[...o];var l;localStorage.setItem("indicatorKeysUser",JSON.stringify(o)),l=e,u(n),_(l)}c.useEffect((()=>(h(),o.forEach((e=>{_(e)})),()=>{t(!1)})),[]);const N=d.debounce(((e,t)=>{h({metric:e},t)}),500);return c.createElement("div",{className:"part indicator_part"},c.createElement("div",{className:"title"},"指标TOP"),c.createElement("div",null,c.createElement(i,{justify:"space-between",gutter:18},null==o?void 0:o.map(((e,t)=>{var a;return c.createElement(m,{key:t,span:6},c.createElement("div",null,c.createElement(p,{className:"table_select",size:"middle",key:t,defaultValue:e,showSearch:!0,filterOption:!1,onSearch:e=>{N(e,t)},onChange:g},null==(a=E[t])?void 0:a.map(((e,a)=>c.createElement(q,{key:`${t}-${a}`,value:null==e?void 0:e.name},null==e?void 0:e.name)))),c.createElement(v,{columns:y,size:"small",dataSource:l[e],pagination:!1})))})))))},{confirm:F}=N,H=e=>{const{event_total_day:t,event_total_month:a,event_total_week:n}=e,[l,r]=c.useState(""),s=c.useRef(null),o=E(),u=f(),d=[{title:"级别",dataIndex:"priority",render:e=>c.createElement(y,{color:I[e-1]},"P",e)},{title:"策略名称",dataIndex:"rule_name",render:(e,t)=>c.createElement("div",{className:"table-active-text",onClick:()=>{o({type:"event/editItem",data:t}),u.push("/event/"+t.id)}},e)},{title:"资源分组",dataIndex:"res_classpaths",render:e=>c.createElement(c.Fragment,null,e?e.split(" ").map(((e,t)=>e?c.createElement(j,{text:e,key:t}):null)):"")},{title:"标签",dataIndex:"tags",render:e=>c.createElement(c.Fragment,null,e?e.trim().split(" ").map(((e,t)=>e?c.createElement(j,{text:e,key:t}):null)):"")},{title:"通知",dataIndex:"notify_group_objs",render:(e,t)=>{const{notify_user_objs:a}=t;let n=[];return e&&(n=n.concat(e.map((e=>e.name)))),a&&(n=n.concat(a.map((e=>e.nickname)))),c.createElement(c.Fragment,null,n?n.map(((e,t)=>e?c.createElement(j,{text:e,key:t}):null)):"")}},{title:"状态",width:80,dataIndex:"status",render:e=>e===C.Enable?"已发送":"已屏蔽"},{title:"发生时间",width:180,dataIndex:"trigger_time",render:e=>h(1e3*e).format("YYYY-MM-DD HH:mm:ss")},{title:"操作",width:100,dataIndex:"operator",render:(e,t)=>{const{id:a}=t;return c.createElement("div",{className:"table-operator-area"},c.createElement("div",{className:"table-operator-area-normal",onClick:()=>{o({type:"event/editItem",data:t}),u.push("/shield/add/event")}},"屏蔽"),c.createElement("div",{className:"table-operator-area-warning",onClick:()=>{F({title:"是否忽略该告警?",onOk:()=>{z([a]).then((()=>{g.success("已忽略该告警"),s.current.refreshList()}))},onCancel(){}})}},"忽略"))}}];let p;const[v,N]=c.useState(!0);return c.useEffect((()=>(v&&(p=setInterval((()=>{s.current.refreshList()}),6e4)),()=>{clearInterval(p)})),[]),c.createElement("div",{className:"part event_part"},c.createElement("div",{className:"event_t"},c.createElement("span",{className:"title"},"告警事件")),c.createElement("div",null,c.createElement(i,{justify:"start",gutter:18},c.createElement(m,null,c.createElement("div",{className:"list day_part"},c.createElement("div",{className:"name"},"近 1 天未恢复的"),c.createElement("div",{className:"num"},t),c.createElement(P,{className:"list_icon",type:"icon-a-1tianweihuifu"}))),c.createElement(m,null,c.createElement("div",{className:"list week_part"},c.createElement("div",{className:"name"},"近 7 天未恢复的"),c.createElement("div",{className:"num"},n),c.createElement(P,{className:"list_icon",type:"icon-a-7tianweihuifu"}))),c.createElement(m,null,c.createElement("div",{className:"list month_part"},c.createElement("div",{className:"name"},"近 30 天未恢复的"),c.createElement("div",{className:"num"},a),c.createElement(P,{className:"list_icon",type:"icon-a-30tianweihuifu"})))),c.createElement("div",{className:"refresh_con clearfix"},c.createElement(w,{className:"searchInput",placeholder:"策略名称、标签、资源分组",onSearch:r}),c.createElement(_,{style:{marginLeft:"15px",marginRight:"15px"},defaultChecked:!0,onChange:function(e){N(e)}}),"一分钟自动刷新"," ",c.createElement("span",{className:"float_r refresh_icon"},c.createElement("a",{className:"enterEventBtn",type:"primary",onClick:function(){u.push("/event")}},"进入事件管理"))),c.createElement(x,{fetchParams:{query:l},ref:s,rowKey:"id",fetchHandle:O,columns:d})))};export default()=>{const[e,t]=c.useState(!0),[a,n]=c.useState(J),[l,s]=c.useState(0),[i,m]=c.useState(0),[o,u]=c.useState(0),d=async()=>{const t=await function(e={}){return S(`${b}/api/n9e/status`,{method:k.Get,params:e})}();if(null==t?void 0:t.dat){const a=t.dat;J.forEach(((e,t)=>{const n=r(r({},e),{num:a[e.id]});J[t]=n}));const l=[...J];e&&(n(l),s(a.event_total_day),m(a.event_total_week),u(a.event_total_month))}};return c.useEffect((()=>(d(),()=>{t(!1)})),[]),c.createElement("div",{className:"overview_con"},c.createElement("div",{className:"part"},c.createElement("div",{className:"title"},"统计数据"),c.createElement($,{list:a,spanNum:4})),c.createElement(Y,null),c.createElement(H,{event_total_day:l,event_total_week:i,event_total_month:o}))};
